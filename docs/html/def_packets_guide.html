<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NUsolar CAN: Creating New Packet Layouts Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NUsolar CAN
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Creating New Packet Layouts Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>NUsolar <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a> CAN Library for Arduino &ndash; Defining New CAN Packet Layouts </h1>
<p>Author: Alexander Martin</p>
<p>Last Revised: 9/8/2017</p>
<p>Library Version: 3.0</p>
<p>Full Documentation: <a href="https://nusolar.github.io/NUsolar-CAN/docs/html/index.html">https://nusolar.github.io/NUsolar-CAN/docs/html/index.html</a></p>
<h3>List of Tables</h3>
<ol type="1">
<li><a href="#Table 1">Table 1 &ndash; New Packet Layout Specification</a></li>
<li><a href="#Table 2">Table 2 - CAN data representation within the Frame object</a></li>
</ol>
<h2>Introduction </h2>
<p>This guide shows how to extend the functionality of the existing library by implementing your own CAN packet <a class="el" href="class_layout.html">layouts</a>. Changes and improvements to the various peripherial systems in your solar vehicle will invariably require adding, removing, or modifying the types of data that are sent over the CAN bus. By creating a custom packet layout, you ensure that your data is sent and received in exactly the same manner. With a custom CAN packet layout, you don't need to know the exact location of the data within your CAN frame each time you wish to use your custom packet; that information is programmed into the packet layout so the work is done for you.</p>
<p>Before starting, you should have the following information at hand:</p><ul>
<li>The type and size of the data that you want to send in the custom packet</li>
<li>The location (within the 64 bit can frame) where each peice of your data will be located (making sure they do not overlap)</li>
<li>A unique packet ID for your custom packet. A valid packet ID is a hex number between 0x000 and 0x7FF. See <a class="el" href="_layouts_8h.html">Layouts.h</a> for more information.</li>
</ul>
<p>You should also be familar with the following concepts in C++:</p><ul>
<li>Inheritance</li>
<li>Member initialization syntax for constructors</li>
<li>Overloaded functions</li>
<li>Bit-wise operators</li>
<li>Unions (not strictly necessary, but helps to understand what is going on)</li>
</ul>
<h2>Planning </h2>
<p>For this guide, lets pretend that we are creating a packet to report information about the state of the driver foot controls. (The <a class="el" href="class_d_c___info.html" title="Driver controls information packet. ">DC_Info</a> packet does this already, but we will be simiplifying things for pedegogical purposes.) We will need to transmit the following information and data types:</p><ul>
<li>Accelerator pedal position &ndash; Unsigned integer value from 0 to 100</li>
<li>Regen pedal position &ndash; Unsigned integer value from 0 to 100</li>
<li>Brake status &ndash; Boolean value (on or off)</li>
<li>Direction of Motion (gear) &ndash; Signed integer value (-1, 0, 1) corresponding to (reverse, neutral, and forward)</li>
</ul>
<p>Within the 8 byte CAN frame, we will structure the data as shown in the table below.</p>
<h3><a class="anchor" id="Table 1"></a>Table 1 &ndash; New Packet <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> Specification</h3>
<table class="doxtable">
<tr>
<th>Packet Location </th><th>Data  </th></tr>
<tr>
<td>Byte 0, 1 </td><td>Accelerometer Position </td></tr>
<tr>
<td>Byte 2, 3 </td><td>Regen Position </td></tr>
<tr>
<td>Byte 4 </td><td>Brake status </td></tr>
<tr>
<td>Byte 5 </td><td>UNUSED </td></tr>
<tr>
<td>Byte 6, 7 </td><td>Direction of Motion </td></tr>
</table>
<p>Note: Because brake status and direction of motion really only require 1 and 2 bits of information respectively, I could have decided the package them together into the first 3 bits of Byte 4, leaving 3 bytes open for communicating more information.</p>
<p>Now that we have a plan for where our data will go, we are ready to begin writing a child layout class.</p>
<h2>Creating a child layout class </h2>
<p>To create a new custom packet layout, you will define a new child class of the <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class. The best place to do this is within the <a class="el" href="_layouts_8h.html">Layouts.h</a> and <a class="el" href="_layouts_8cpp.html" title="Implementation of CAN packet layouts. ">Layouts.cpp</a> files. Within this new class, you must define the following:</p><ul>
<li>Member variables for every peice of data you wish to send within the CAN packet.</li>
<li>A constructor to intialize the packet from data that you specify in arguments</li>
<li>A constructor to initialize the packet from a <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object which already contains data (i.e. one that you have received from the CAN bus)</li>
<li>A generate_frame() method which places the data values into the correct locations within a <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object.</li>
</ul>
<p>The easiest way to make a new child <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class is to copy the code for an existing child layout class and then modify it to meet your needs. In this guide, however, we will start from scratch. Remember that if you do copy code, you will need to make changes in both the Layout.h and Layout.cpp files.</p>
<p>The base structure for our new child class will be: </p><div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ** \brief A one-line comment describing your packet&#39;s purpose.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span>DriverFootControls_pkt : <span class="keyword">public</span> <a class="code" href="class_layout.html">Layout</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="struct_frame.html">Frame</a> <a class="code" href="class_layout.html#af50d9174dd7132e8ec6af0b7e7e5c759">generate_frame</a>() <span class="keyword">const</span>;</div><div class="line">};</div></div><!-- fragment --><p>Here, we have created a new class DriverFootContrls_pkt that inherits the public members of the <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class. Furthermore, we have declared a constant method called generate_frame() which returns a frame object.</p>
<p>Next, we will define variables within the class to hold our data values.</p>
<h2>Packet variables </h2>
<p>Since we already know what variables we want to include in the packet, as well as their types, this next part is easy. Create member variables of the new class to temporarily store these values. Like this:</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ** \brief A one-line comment describing your packet&#39;s purpose.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span>DriverFootControls_pkt : <span class="keyword">public</span> <a class="code" href="class_layout.html">Layout</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="struct_frame.html">Frame</a> <a class="code" href="class_layout.html#af50d9174dd7132e8ec6af0b7e7e5c759">generate_frame</a>() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    uint16_t    acclerator_position; <span class="comment">//&lt;--</span></div><div class="line">    uint16_t    regen_position;      <span class="comment">//&lt;--</span></div><div class="line">    <span class="keywordtype">bool</span>        brake_status;        <span class="comment">//&lt;--</span></div><div class="line">    int16_t     motion_dir;          <span class="comment">//&lt;--</span></div><div class="line">};</div></div><!-- fragment --><p>Note that the order in which we declare these variables doesn't affect the order that they go into the CAN packet. However, it helps to define them in the same order for readability. Also note that the types of the variables correspond to the way that they will be stored in the CAN packet. In general, we should stick to the varaible types listed in Table 2, as they are compatible with the type overrides that have been defined for the CAN packet within the <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> class.</p>
<p>Now that you have member variables defined, we need to set up an easy way to put values into these variables, as well as a way to "load" the variables from an incoming CAN <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a>. We will do this in the next section with constructors.</p>
<h2>Defining constructors </h2>
<p>There are two types of constructor that you should define for a custom packet layout.</p><ol type="1">
<li>A "value-based" constructor that initializes your packet based on arguments that the user provides.</li>
<li>A "Frame-based" constructor that loads the data into your packet layout object from the appropriate location in a CAN frame.</li>
</ol>
<p>The type 1 constructor is typically used when sending a packet over CAN, while the type 2 constructor is used to help read incoming <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> objects that have been read from the CAN bus. See the sendandreceive.ino example to see this distinction in practice.</p>
<p>We will write all of our constructor code in the Layout.h file, inside the class you created in the previous section. First, create declarations for the constructors as shown below. In the code for each constructor method, we will set the ID of the packet layout. <code>id</code> is a variable that your custom packet layout inherits from the <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class. Here, I have already added DRIVERFOOTCTRLS_ID as a constant at the top of the <a class="el" href="_layouts_8h.html">Layouts.h</a> file.</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ** \brief A one-line comment describing your packet&#39;s purpose.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span>DriverFootControls_pkt : <span class="keyword">public</span> <a class="code" href="class_layout.html">Layout</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    DriverFootControls_pkt(uint16_t accl, uint16_t regen, <span class="keywordtype">bool</span> brake, int16_t motion_dir) <span class="comment">//&lt;-- Type 1 constructor</span></div><div class="line">    { <span class="keywordtype">id</span> = DRIVERFOOTCTRLS_ID; }</div><div class="line">    DriverFootControls_pkt(<span class="keyword">const</span> <a class="code" href="struct_frame.html">Frame</a>&amp; frame) <span class="comment">//&lt;-- Type 2 constructor</span></div><div class="line">    { <span class="keywordtype">id</span> = frame.<a class="code" href="struct_frame.html#af0b7b5066af6657239ab3c3fe5174bd3">id</a>; }</div><div class="line"></div><div class="line">    <a class="code" href="struct_frame.html">Frame</a> <a class="code" href="class_layout.html#af50d9174dd7132e8ec6af0b7e7e5c759">generate_frame</a>() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    uint16_t    acclerator_position;</div><div class="line">    uint16_t    regen_position;     </div><div class="line">    <span class="keywordtype">bool</span>        brake_status;       </div><div class="line">    int16_t     motion_dir;         </div><div class="line">};</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>It is important that your constructor arguments not be named identically to your member variables, or else you will get naming conflicts in the next step.</dd></dl>
<p>Finally, we use member initialzation syntax to initialize values in the member variables we created.</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ** \brief A one-line comment describing your packet&#39;s purpose.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span>DriverFootControls_pkt : <span class="keyword">public</span> <a class="code" href="class_layout.html">Layout</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="comment">// Type 1 constructor</span></div><div class="line">    DriverFootControls_pkt(uint16_t accl, uint16_t regen, <span class="keywordtype">bool</span> brake, int16_t dir) </div><div class="line">    : accelerator_position(accl), regen_position(regen), brake_status(brake), motion_dir(dir) <span class="comment">//&lt;-- Type 1 member initialization</span></div><div class="line">    { <span class="keywordtype">id</span> = DRIVERFOOTCTRLS_ID; }</div><div class="line"></div><div class="line">    <span class="comment">// Type 2 constructor</span></div><div class="line">    DriverFootControls_pkt(<span class="keyword">const</span> <a class="code" href="struct_frame.html">Frame</a>&amp; frame)</div><div class="line">    accelerator_position(frame.i0), regen_position(frame.i1), brake_status(frame.data[4]), motion_dir(frame.s3) <span class="comment">//&lt;-- Type 2 member initialization</span></div><div class="line">    { <span class="keywordtype">id</span> = frame.id; }</div><div class="line"></div><div class="line">    <a class="code" href="struct_frame.html">Frame</a> <a class="code" href="class_layout.html#af50d9174dd7132e8ec6af0b7e7e5c759">generate_frame</a>() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    uint16_t    acclerator_position;</div><div class="line">    uint16_t    regen_position;     </div><div class="line">    <span class="keywordtype">bool</span>        brake_status;       </div><div class="line">    int16_t     motion_dir;         </div><div class="line">};</div></div><!-- fragment --><p>Note that for the Type 1 constructor, initialzation is easy; initialze each member variable to its corresponding constructor argument, i.e.</p>
<ul>
<li>accl -&gt; accelerator_position</li>
<li>regen -&gt; regen_position</li>
<li>brake -&gt; brake_status</li>
<li>dir -&gt; motion_dir</li>
</ul>
<p>For the Type 2 constructor, initialzation gets more tricky. The pairing goes like this:</p>
<ul>
<li>frame.i0 -&gt; accelerator_position</li>
<li>frame.i1 -&gt; regen_position</li>
<li>frame.data[4] -&gt; brake_status</li>
<li>frame.s3 -&gt; motion_dir</li>
</ul>
<p>The variables <code>i0, i1, data[4], and s3</code> all represent different ways to access the data stored within the <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object. Remember that the CAN data frame is 8 bytes that can be broken down several different ways: 1 64 bit integer, 2 floats (32 bit numbers), 4 ints (signed or unsigned), or as individual bytes, just to name a few. You might have already guessed that i0 represents an unsigned integer, while s3 represents a signed integer. Now is probably a good time to show you all the ways you can access the <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> data.</p>
<h3><a class="anchor" id="Table 2"></a> Table 2 - CAN data representation within the <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object</h3>
<table class="doxtable" style="text-align:center">
<tr>
<th>Bits 0..7</th><th>Bits 8..15</th><th>Bits 16..23</th><th>Bits 24..31</th><th>Bits 32..39</th><th>Bits 40..47</th><th>Bits 48..55</th><th>Bits 56..63 </th></tr>
<tr>
<td>uint8_t <b>data[0]</b> </td><td>uint8_t <b>data[1]</b> </td><td>uint8_t <b>data[2]</b> </td><td>uint8_t <b>data[3]</b> </td><td>uint8_t <b>data[4]</b> </td><td>uint8_t <b>data[5]</b> </td><td>uint8_t <b>data[6]</b> </td><td>uint8_t <b>data[7]</b>  </td></tr>
<tr>
<td colspan="2">int16_t <b>i0</b> </td><td colspan="2">int16_t <b>i1</b> </td><td colspan="2">int16_t <b>i2</b> </td><td colspan="2">int16_t <b>i3</b>  </td></tr>
<tr>
<td colspan="2">uint16_t <b>s0</b> </td><td colspan="2">uint16_t <b>s1</b> </td><td colspan="2">uint16_t <b>s2</b> </td><td colspan="2">uint16_t <b>s3</b>  </td></tr>
<tr>
<td colspan="4">int32_t <b>high_s</b> </td><td colspan="4">int32_t <b>low_s</b>  </td></tr>
<tr>
<td colspan="4">uint32_t <b>high</b> </td><td colspan="4">uint32_t <b>low</b>  </td></tr>
<tr>
<td colspan="8">int64_t <b>value_s</b>  </td></tr>
<tr>
<td colspan="8">uint64_t <b>value</b> </td></tr>
</table>
<p>This information will also be useful to us in the next section, where we write the code that will generate a <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object using the data stored in your new custom packet.</p>
<h2>Defining generate_frame() </h2>
<p>The <a class="el" href="class_layout.html#af50d9174dd7132e8ec6af0b7e7e5c759" title="Creates a Frame object to represent this layout. ">Layout::generate_frame()</a> method is called by <a class="el" href="class_c_a_n___i_o.html#a71e0198aa24bd6125e0a5f0598bb33d5" title="Sends messages to the CAN bus via the controller. ">CAN_IO::Send()</a> whenever you pass a child class of <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> into Send() as an argument. generate_frame() returns a <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object that has been filled with the appropriate data at the correct positions, so it is unique for every type of CAN packet layout. Our next step is to define the generate_frame() method of the DriverFootControls class so that <a class="el" href="class_c_a_n___i_o.html#a71e0198aa24bd6125e0a5f0598bb33d5" title="Sends messages to the CAN bus via the controller. ">CAN_IO::Send()</a> can process it.</p>
<p>To write the generate_frame() method, switch over to the <a class="el" href="_layouts_8cpp.html" title="Implementation of CAN packet layouts. ">Layouts.cpp</a> file. Again, it may be easier in practice to copy an existing method and modify it to suit your needs, but we will begin from scratch. The general structure for a generate_frame() method is:</p>
<div class="fragment"><div class="line"><a class="code" href="struct_frame.html">Frame</a> DriverFootControls::generate_frame()<span class="keyword"> const </span>{</div><div class="line">    <a class="code" href="struct_frame.html">Frame</a> f;            <span class="comment">// Declare a new frame object</span></div><div class="line">    ;                   <span class="comment">// Assign the packet&#39;s named variables to</span></div><div class="line">    ;                   <span class="comment">//   specific locations within the frame&#39;s</span></div><div class="line">    ;                   <span class="comment">//   annonymous union (using the varaibles from Table 2)</span></div><div class="line">    set_header(f);      <span class="comment">// Setup the header info in the Frame -- this is just calling a helper function that is defined in Layouts.cpp</span></div><div class="line">    <span class="keywordflow">return</span> f;           <span class="comment">// Return the frame back to the calling function, usually CAN_IO::Send()</span></div><div class="line">}</div></div><!-- fragment --><p>Now all we need to do is fill in those missing lines with code that will take data from the member variables of DriverFootControls and put it into the correct location within the <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object "f". Given how we have defined our positions and types in <a href="#Table 1">Table 1</a>, our final code will look like this:</p>
<div class="fragment"><div class="line"><a class="code" href="struct_frame.html">Frame</a> DriverFootControls::generate_frame()<span class="keyword"> const </span>{</div><div class="line">    <a class="code" href="struct_frame.html">Frame</a> f;</div><div class="line"></div><div class="line">    f.<a class="code" href="struct_frame.html#a0724b69d04976c9a6c3d0032d0c59363">i0</a> = accelerometer_position;</div><div class="line">    f.<a class="code" href="struct_frame.html#a83b263f3c811f77f1bdaabd6e056a1d3">i1</a> = regen_position;</div><div class="line">    f.<a class="code" href="struct_frame.html#ae0fe3c949ea3663f35ff7d6d5c2376f4">data</a>[4] = brake_status;</div><div class="line">    f.<a class="code" href="struct_frame.html#ae0fe3c949ea3663f35ff7d6d5c2376f4">data</a>[5] = <a class="code" href="_layouts_8cpp.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a>;</div><div class="line">    f.<a class="code" href="struct_frame.html#a50ad5fcad2e6d9669522c51b17a172c5">s3</a> = motion_dir;</div><div class="line"></div><div class="line">    set_header(f);</div><div class="line">    <span class="keywordflow">return</span> f;</div><div class="line">}</div></div><!-- fragment --><p>Notice how this code is essentially the mirror operation of the what happens in the member initialization of the Type 2 constructor. You should be very careful to ensure these two match in terms of where data is read from and written to within the <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object.</p>
<dl class="section note"><dt>Note</dt><dd>We set frame.data[5] to the special constant UNUSED (defined as 0). This ensures that data[5], which we did not specify we were going to put data in, is not filled with random (undefined) values. It's not strictly necessary to set all unused parts of the <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> to UNUSED, but it can help prevent mistakes further down the road.</dd></dl>
<p>And that's it; we defined a custom packet layout for the CAN library. Double-check that your code compiles and then start using <code>CanControl.Send(DriverFootControls(50,0,false,FORWARD))</code> in your code just like any other packet type.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000012">Todo:</a></b></dt><dd>Adding packet-related constants: Purpose, use cases and examples. Defining static members (link to static members tutorials) Examples of how to access static members from external code. </dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
