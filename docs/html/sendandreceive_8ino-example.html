<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NUsolar CAN: sendandreceive.ino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NUsolar CAN
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">sendandreceive.ino</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="_c_a_n___i_o_8h.html">CAN_IO.h</a>&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;SPI.h&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// First the CAN parameters are initialized</span></div><div class="line"><span class="keyword">const</span> byte     CAN_CS      = 10;      <span class="comment">// The arduino pin to which the MCP2515 CS (chip select) input is attached</span></div><div class="line"><span class="keyword">const</span> byte     CAN_INT     = 2;       <span class="comment">// The arduino pin to which the MPC2515 INT (interrupt) pin is attached</span></div><div class="line"><span class="keyword">const</span> uint16_t CAN_BAUD_RATE = 1000;  <span class="comment">// MUST match the baud rate of the CAN bus. Setting this to 0 will enable Auto-BAUD (untested)</span></div><div class="line"><span class="keyword">const</span> byte     CAN_FREQ      = 16;    <span class="comment">// MUST BE the frequency of the oscillator you use</span></div><div class="line"></div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> previous_send_time = 0; <span class="comment">// A timing variable we define to keep </span></div><div class="line"></div><div class="line"><span class="comment">// Then the can controller object is set up using the configuration variables.</span></div><div class="line"><a name="_a0"></a><a class="code" href="class_c_a_n___i_o.html">CAN_IO</a> CanControl(CAN_CS,CAN_INT,CAN_BAUD_RATE,CAN_FREQ);</div><div class="line"></div><div class="line"><span class="comment">//  </span></div><div class="line"><span class="comment">//  The Arduino Setup() routine begins the SPI protocols to output received data to the COM window, Sets the applicable CAN filters,</span></div><div class="line"><span class="comment">//  and then calls the CAN_IO::Setup() routine. In this case, the CAN controller is set up to listen only for BMS State of Charge and </span></div><div class="line"><span class="comment">//  motor controller velocity data packets.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keywordtype">void</span> setup() {</div><div class="line">  <span class="comment">// Start serial here so that we can communicate with the test computer. Not necessary for CAN to work.</span></div><div class="line">  Serial.begin(9600);</div><div class="line"></div><div class="line">  <span class="comment">// Here is where we specify which packets we want to filter out, and then instruct the controler to</span></div><div class="line">  <span class="comment">// initialize using the Setup command</span></div><div class="line">  CanControl.filters.setRB0(<a name="a1"></a><a class="code" href="_layouts_8h.html#a18b4061cc90be421890eb9da2b1afa98">MASK_Sxxx</a>,<a name="a2"></a><a class="code" href="_layouts_8h.html#aae9e8118969fe8604c61cb2a28df4ac4">BMS_SOC_ID</a>, <a name="a3"></a><a class="code" href="_layouts_8h.html#a3d61d13dd8174b339e37721aabcd6586">MC_VELOCITY_ID</a>); </div><div class="line">  CanControl.filters.setRB1(<a class="code" href="_layouts_8h.html#a18b4061cc90be421890eb9da2b1afa98">MASK_Sxxx</a>,0,0,0,0);</div><div class="line">  CanControl.Setup();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> loop() {</div><div class="line">  <span class="comment">/******* FETCH ********/</span></div><div class="line"></div><div class="line">  <span class="comment">// If there are any new messages, they will be loaded from the MCP2515 into an internal buffer with</span></div><div class="line">  <span class="comment">// this function call</span></div><div class="line">  CanControl.Fetch(); </div><div class="line"></div><div class="line">  <span class="comment">/******  SEND  ********/</span></div><div class="line">  <span class="comment">// Now, we send data over the CAN bus every 500 ms</span></div><div class="line">  <span class="keywordflow">if</span> (millis() - previous_send_time &gt; 500) <span class="comment">// Check and see whether it is time to send another packet</span></div><div class="line">  {</div><div class="line">    <span class="comment">// Send the binary data 01101100, and let the arduino choose which TX (transmit) buffer on the MCP2515 to use</span></div><div class="line">    <span class="comment">// If all you care about is sending data, you can stop after running this command.</span></div><div class="line">    CanControl.Send(<a name="_a4"></a><a class="code" href="class_s_w___data.html">SW_Data</a>(0b01101100),<a name="a5"></a><a class="code" href="_m_c_p2515__defs_8h.html#a9a0dc14d98d9b8bdab544804c39f63ac">TXBANY</a>);</div><div class="line"></div><div class="line">    <span class="comment">// To help with debugging the CAN bus, you can print out the error counters of the MCP2515. </span></div><div class="line">    <span class="comment">// Before you read these values, you need to fetch them using the FetchErrors() command, which grabs</span></div><div class="line">    <span class="comment">// status and error counter registers.</span></div><div class="line">    <span class="comment">// If you see the TEC and/or REC counters continuously incrementing, it means that your MCP2515</span></div><div class="line">    <span class="comment">// is not able to sucessfully read and/or write messages to the CAN bus. You should troubleshoot the issue</span></div><div class="line">    <span class="comment">// (See the troubleshooting guide in the documentation)</span></div><div class="line"></div><div class="line">    CanControl.FetchErrors(); <span class="comment">//Call this first to get the error data from the MCP2515</span></div><div class="line">    Serial.print(<span class="stringliteral">&quot;TEC/REC &quot;</span>);</div><div class="line">    Serial.print(CanControl.tec); Serial.print(<span class="stringliteral">&quot;, &quot;</span>);</div><div class="line">    Serial.println(CanControl.rec);</div><div class="line"></div><div class="line">    <span class="comment">// This line resets the timing variable we use to send CAN packets.</span></div><div class="line">    previous_send_time = millis();</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">/******* RECEIVE *******/</span></div><div class="line">  <span class="comment">// Here we check to see if any messages were loaded when we called CanControl.Fetch() on line 35.</span></div><div class="line">  <span class="keywordflow">if</span> (CanControl.Available())</div><div class="line">  {</div><div class="line">    <span class="comment">// Get the frame of of the buffer. Read() returns a reference to a frame object which we can then convert into a string</span></div><div class="line">    <a name="_a6"></a><a class="code" href="struct_frame.html">Frame</a>&amp; f = CanControl.Read();</div><div class="line"></div><div class="line">    <span class="comment">// Print the frame over serial to the test computer</span></div><div class="line">    Serial.print(f.<a name="a7"></a><a class="code" href="struct_frame.html#aba2b2fdcb740721bc35968fb6905a1a5">toString</a>());</div><div class="line">  }</div><div class="line"></div><div class="line">  <span class="comment">// Run the loop() function every 100 ms</span></div><div class="line">  delay(100);</div><div class="line">}</div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
