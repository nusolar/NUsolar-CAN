<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NUsolar CAN: Creating New Packet Layouts Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NUsolar CAN
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Creating New Packet Layouts Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>NUsolar <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a> CAN Library for Arduino &ndash; Defining New CAN Packet Layouts </h1>
<p>Author: Alexander Martin</p>
<p>Last Revised: 9/8/2017</p>
<p>Library Version: 3.0</p>
<p>Full Documentation: <a href="https://nusolar.github.io/NUsolar-CAN/docs/html/index.html">https://nusolar.github.io/NUsolar-CAN/docs/html/index.html</a></p>
<h2>Introduction </h2>
<p>This guide shows how to extend the functionality of the existing library by implementing your own CAN packet <a class="el" href="class_layout.html">layouts</a>. Changes and improvements to the various peripherial systems in your solar vehicle will invariably require adding, removing, or modifying the types of data that are sent over the CAN bus. By creating a custom packet layout, you ensure that your data is sent and received in exactly the same manner. With a custom CAN packet layout, you don't need to know the exact location of the data within your CAN frame each time you wish to use your custom packet; that information is programmed into the packet layout so the work is done for you.</p>
<p>Before starting, you should have the following information at hand:</p><ul>
<li>The type and size of the data that you want to send in the custom packet</li>
<li>The location (within the 64 bit can frame) where each peice of your data will be located (making sure they do not overlap)</li>
<li>A unique packet ID for your custom packet. A valid packet ID is a hex number between 0x000 and 0x7FF. See <a class="el" href="_layouts_8h.html">Layouts.h</a> for more information.</li>
</ul>
<p>You should also be familar with the following concepts in C++:</p><ul>
<li>Inheritance</li>
<li>Constructor initialization of variables</li>
<li>Overloaded functions</li>
<li>Bit-wise operators</li>
<li>Unions (not strictly necessary, but helps to understand what is going on)</li>
</ul>
<h2>Planning </h2>
<p>For this guide, lets pretend that we are creating a packet to report information about the state of the driver foot controls. (The <a class="el" href="class_d_c___info.html" title="Driver controls information packet. ">DC_Info</a> packet does this already, but we will be simiplifying things for pedegogical purposes.) We will need to transmit the following information and data types:</p><ul>
<li>Accelerator pedal position &ndash; Unsigned integer value from 0 to 100</li>
<li>Regen pedal position &ndash; Unsigned integer value from 0 to 100</li>
<li>Brake status &ndash; Boolean value (on or off)</li>
<li>Direction of Motion (gear) &ndash; Signed integer value (-1, 0, 1) corresponding to (reverse, neutral, and forward)</li>
</ul>
<p>Within the 8 byte CAN frame, we will structure the data as shown in the table below.</p>
<p>Table 1 </p><table class="doxtable">
<tr>
<th>Packet Location </th><th>Data  </th></tr>
<tr>
<td>Byte 0, 1 </td><td>Accelerometer Position </td></tr>
<tr>
<td>Byte 2, 3 </td><td>Regen Position </td></tr>
<tr>
<td>Byte 4 </td><td>Brake status </td></tr>
<tr>
<td>Byte 5 </td><td>UNUSED </td></tr>
<tr>
<td>Byte 6, 7 </td><td>Direction of Motion </td></tr>
</table>
<p>Note: Because brake status and direction of motion really only require 1 and 2 bits of information respectively, I could have decided the package them together into the first 3 bits of Byte 4, leaving 3 bytes open for communicating more information.</p>
<p>Now that we have a plan for where our data will go, we are ready to begin writing a child <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class.</p>
<h2>Creating a child <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class </h2>
<p>To create a new custom packet layout, you will define a new child class of the <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class. The best place to do this is within the <a class="el" href="_layouts_8h.html">Layouts.h</a> and <a class="el" href="_layouts_8cpp.html" title="Implementation of CAN packet layouts. ">Layouts.cpp</a> files. Within this new class, you must define the following:</p><ul>
<li>Member variables for every peice of data you wish to send within the CAN packet.</li>
<li>A constructor to intialize the packet from data that you specify in arguments</li>
<li>A constructor to initialize the packet from a <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object which already contains data (i.e. one that you have received from the CAN bus)</li>
<li>A generate_frame() method which places the data values into the correct locations within a <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> object.</li>
</ul>
<p>The easiest way to make a new child <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class is to copy the code for an existing child <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class and then modify it to meet your needs. In this guide, however, we will start from scratch. Remember that if you do copy code, you will need to make changes in both the Layout.h and Layout.cpp files.</p>
<p>The base structure for our new child class will be: </p><div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ** \brief A one-line comment describing your packet&#39;s purpose.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span>DriverFootControls_pkt : <span class="keyword">public</span> <a class="code" href="class_layout.html">Layout</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="struct_frame.html">Frame</a> <a class="code" href="class_layout.html#af50d9174dd7132e8ec6af0b7e7e5c759">generate_frame</a>() <span class="keyword">const</span>;</div><div class="line">};</div></div><!-- fragment --><p>Here, we have created a new class DriverFootContrls_pkt that inherits the public members of the <a class="el" href="class_layout.html" title="Abstract Layout Packet Base Class. ">Layout</a> class. Furthermore, we have declared a constant method called generate_frame() which returns a frame object.</p>
<p>Next, we will define variables within the class to hold our data values.</p>
<h2>Packet variables </h2>
<p>Since we already know what variables we want to include in the packet, as well as their types, this next part is easy. Create member variables of the new class to temporarily store these values. Like this:</p>
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> ** \brief A one-line comment describing your packet&#39;s purpose.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span>DriverFootControls_pkt : <span class="keyword">public</span> <a class="code" href="class_layout.html">Layout</a> {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <a class="code" href="struct_frame.html">Frame</a> <a class="code" href="class_layout.html#af50d9174dd7132e8ec6af0b7e7e5c759">generate_frame</a>() <span class="keyword">const</span>;</div><div class="line"></div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    acclerator_position;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>    regen_position;</div><div class="line">    <span class="keywordtype">bool</span>            brake_status;</div><div class="line">    <span class="keywordtype">int</span>             motion_dir;</div><div class="line">};</div></div><!-- fragment --><p>Note that the order in which you declare these variables doesn't affect the order that they go into the CAN packet. However, it helps to define them in the same order for readability. Also note that the types of the variables correspond to the way that they will be stored in the CAN packet. In general, you should stick to the varaible types listed in Table 2, as they are compatible with the type overrides that have been defined for the CAN packet within the <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> class.</p>
<h2>Defining constructors </h2>
<p>Value constructor and <a class="el" href="struct_frame.html" title="An object representing a generic CAN frame. ">Frame</a> constructor</p>
<h2>Defining generate_frame() </h2>
<p>Basic description with link to generate_frame() documentation Using UNUSED.</p>
<h2>Adding packet-related constants </h2>
<p>Purpose, use cases and examples. Defining static members (link to static members tutorials) Examples of how to access static members from external code. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
