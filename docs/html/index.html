<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NUsolar CAN: NUsolar MCP2515 CAN Library for Arduino</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">NUsolar CAN
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">NUsolar <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a> CAN Library for Arduino </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Author: Alexander Martin</p>
<p>Date: 6/13/2015</p>
<p>Version: 3.0</p>
<p>Full Documentation: <a href="https://nusolar.github.io/NUsolar-CAN/docs/html/index.html">https://nusolar.github.io/NUsolar-CAN/docs/html/index.html</a></p>
<h2>Goals </h2>
<p>This library is intended to simplify CAN bus communication for Arduino MCUs in NUsolar's vehicles which use the <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a>. The library encapsulates the entire sending procedure into a single fuction call, and adds a buffer for holding incoming messages. It also defines a large number of packet layouts as classes, which allow data to easily be place into the CAN frame format.</p>
<h2>Installation </h2>
<p>To use the library, simply download the zip file of this repository from github and use the library manager inside Aruduino to load the library into the Arduino IDE.</p>
<h2>Cloning </h2>
<p>If you want to be able to use the library as well as push changes to it, you need to CLONE the git repository into your Arduino Libraries folder. This is typically located in C:/Users/YourUsername/Documents/Arduino/libraries. You should clone the SC7-can repo into this folder, so that the structure looks like: .../Documents/Arduino/libraries/sc7-can/</p>
<p>Once this is done, restart arduino and the NUsolar CAN library should show up under the "Sketch-&gt;Include Libraries" menu.</p>
<p>For more information on installing libraries, visit <a href="http://www.arduino.cc/en/Guide/Libraries">http://www.arduino.cc/en/Guide/Libraries</a>.</p>
<h2>Usage </h2>
<ol type="1">
<li>Create a <a class="el" href="class_c_a_n___i_o.html" title="Class for handling CAN I/O operations using the MCP2515 CAN controller. ">CAN_IO</a> object, specifying the pins that will be used as the CS and INT pins <div class="fragment"><div class="line">CAN_IO can( CSpin, INTpin, baudrate (kbps), freq. Osc. (Mhz));</div></div><!-- fragment --></li>
<li>Setupt filters by calling the setRB&lt;n&gt; methods of the built-in filters object. These methods return their calling object, so they can be daisy-chained, as shown below. <div class="fragment"><div class="line">can.filters.setRB0(m0, f0, f1).setRB1(m1, f2, f3, f4, f5);</div></div><!-- fragment --> to configure the masks and filters for the two receive buffers on the <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a>.</li>
<li>Call <code><a class="el" href="class_c_a_n___i_o.html#a8658429bfd9b825a1e1758514ed387eb" title="Initialization method for the can controller. ">CAN_IO::Setup</a>(&lt;interrupts&gt;)</code> to initialize the <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a>. <code>&lt;interrupts&gt;</code> is a byte containing the interrupt enable flags that you want to set (i.e. MERRIE, ERRIE, RX0IE, etc.) You can OR these flags together to combine them. For example, the following code enables the Message Receive Error, Generic Error, Receive Buffer 0, and Receive Buffer 1 interrupts. <div class="fragment"><div class="line">can.Setup(MERRIE|ERRIE|RX0IE|RX1IE);</div></div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>We recommend that you DO NOT attach the interrupt pin INTpin to an actual Arduino interrupt. Instead, check for messages calling <a class="el" href="class_c_a_n___i_o.html#a02724e01fa0b5d3bd6d50e00f5b4f523" title="Fetch any available messages from the MCP2515. ">CAN_IO::Fetch</a>, which will check the INTpin to see if messages are waiting to be transferred from the <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a> to the Arduino.</dd></dl>
</li>
<li>To send a packet, create a layout object: <div class="fragment"><div class="line">DC_Drive drivePacket(&lt;velocity&gt;, &lt;current&gt;);</div></div><!-- fragment --> Then call <div class="fragment"><div class="line">can.Send(drivePacket,TXB0);</div></div><!-- fragment --> where TXB0 specifies one of the three transmission buffers to send the message out over (alternate buffers to send messages in quicker succession). You can also use an implicit packet object: <div class="fragment"><div class="line">can.Send(DC_Drive(velocity, current), TXB0);</div></div><!-- fragment --> If you want the system to automatically select a TX buffer for you, pass the buffer TXBANY. <div class="fragment"><div class="line">can.Send(DC_Drive(velocity, current), TXBANY);</div></div><!-- fragment --> /note Currently, the library does not wait for a buffer to become open before attempting to load it. If you try to send from a buffer that is currently being used, packet data may be corrupted. Use the TXBANY option to avoid this. Alternatively, you can call <code>CAN_IO::Send_Verified(&lt;packet&gt;, &lt;buffer&gt;)</code> to make sure the correct data was loaded onto the <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a>.</li>
<li>Call <code><a class="el" href="class_c_a_n___i_o.html#a02724e01fa0b5d3bd6d50e00f5b4f523" title="Fetch any available messages from the MCP2515. ">CAN_IO::Fetch()</a></code> at least once per main control loop. This checks for any messages on the <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a> and loads them. It is recommended that this function be used rather than attaching interrupts, as interrupts have been known to cause conflicts with serial communication that results in corrupted CAN data.</li>
<li>Messages retrieved by <code><a class="el" href="class_c_a_n___i_o.html#a02724e01fa0b5d3bd6d50e00f5b4f523" title="Fetch any available messages from the MCP2515. ">CAN_IO::Fetch()</a></code> are loaded into an internal frame FIFO buffer. To get the messages on this buffer, use <div class="fragment"><div class="line">if (can.Available()) {</div><div class="line">    Frame&amp; f = can.Read();</div><div class="line">    /*...*/</div><div class="line">}</div></div><!-- fragment --> The variable <code>f</code> is then a reference to the first frame in the buffer. You can find the packet type of this frame using f.id, which will be a hexidecimal number between 0x000 and 0x7FF.</li>
<li>Once the packet type has been identified, convert it into the appropriate layout class: <div class="fragment"><div class="line">DC_Drive receivedPacket(f);</div></div><!-- fragment --></li>
<li>Access the data using the layout class variables: <div class="fragment"><div class="line">receivedPacket.velocity;</div></div><!-- fragment --></li>
<li>The <a class="el" href="class_c_a_n___i_o.html" title="Class for handling CAN I/O operations using the MCP2515 CAN controller. ">CAN_IO</a> object keeps track of errors that occur in an internal state variable "errors", as well as the TEC and REC counters of the <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a>. To update these, call <a class="el" href="class_c_a_n___i_o.html#a10393f1a9f55c853bb21d74ebbc9d7ca" title="Fetch the error status of the MCP2515 over SPI and update internal variables. ">CAN_IO::FetchErrors()</a>.</li>
<li>The <a class="el" href="class_m_c_p2515.html" title="a class which acts as an interface to the MCP2515 chip. ">MCP2515</a> may occasionally enter sleep mode for random reasons. Code to detect this will be written into the <a class="el" href="class_c_a_n___i_o.html" title="Class for handling CAN I/O operations using the MCP2515 CAN controller. ">CAN_IO</a> class in a future release, but for now the check and reset procedure if this occurs must be done by you.</li>
</ol>
<h2>Example Code </h2>
<div class="fragment"><div class="line">#include &lt;SPI.h&gt;</div><div class="line">#include &lt;CAN_IO.h&gt;</div><div class="line"></div><div class="line">//CAN parameters</div><div class="line">const byte     CAN_CS            = 10;</div><div class="line">const byte     CAN_INT           = 2;</div><div class="line">const uint16_t CAN_BAUD_RATE = 1000;    // MUST match the baud rate of the CAN bus. Setting this to 0 will enable Auto-BAUD (untested)</div><div class="line">const byte     CAN_FREQ      = 16;  // MUST BE the frequency of the oscillator you use</div><div class="line"></div><div class="line">unsigned long previous_send_time = 0;</div><div class="line"></div><div class="line">// Set up the can controller object.</div><div class="line">CAN_IO CanControl(CAN_CS,CAN_INT,CAN_BAUD_RATE,CAN_FREQ);</div><div class="line"></div><div class="line">void setup() {</div><div class="line">  Serial.begin(9600);</div><div class="line"></div><div class="line">  CanControl.filters.setRB0(MASK_Sxxx,BMS_SOC_ID, MC_VELOCITY_ID); </div><div class="line">  CanControl.filters.setRB1(MASK_Sxxx,0,0,0,0);</div><div class="line">  CanControl.Setup();</div><div class="line">}</div><div class="line"></div><div class="line">void loop() {</div><div class="line">  CanControl.Fetch(); //If there are any new messages or TX buffers that have been cleared, they will be received.</div><div class="line"></div><div class="line">  // Sending CAN</div><div class="line">  if (millis() - previous_send_time &gt; 500) // Check and see whether the timer has expired</div><div class="line">  {</div><div class="line">    // This command sends data over any available TX port.</div><div class="line">    CanControl.Send(SW_Data(0b01101100),TXBANY);</div><div class="line"></div><div class="line">    // You can print out the error counters. You can also read registers on the board by using the controller.Read() command.</div><div class="line">    CanControl.FetchErrors(); //Call this first to get the error data from the MCP2515</div><div class="line">    Serial.print(&quot;TEC/REC &quot;);</div><div class="line">    Serial.print(CanControl.tec); Serial.print(&quot;, &quot;);</div><div class="line">    Serial.println(CanControl.rec);</div><div class="line">    Serial.print(&quot;CNF2: &quot; );</div><div class="line">    Serial.println(CanControl.controller.Read(CNF2));</div><div class="line"></div><div class="line">    previous_send_time = millis();</div><div class="line">  }</div><div class="line"></div><div class="line">  if (CanControl.Available()) // Check if there are messages that have been received</div><div class="line">  {</div><div class="line">    // Get the frame of of the buffer</div><div class="line">    Frame&amp; f = CanControl.Read();</div><div class="line"></div><div class="line">    // Print the frame</div><div class="line">    Serial.print(f.toString());</div><div class="line">  }</div><div class="line">  delay(100);</div><div class="line">}</div></div><!-- fragment --><h2>Contact </h2>
<p>Alexander Martin &ndash; <a href="#" onclick="location.href='mai'+'lto:'+'a-m'+'ar'+'tin'+'@u'+'.no'+'rt'+'hwe'+'st'+'ern'+'.e'+'du'; return false;">a-mar<span style="display: none;">.nosp@m.</span>tin@<span style="display: none;">.nosp@m.</span>u.nor<span style="display: none;">.nosp@m.</span>thwe<span style="display: none;">.nosp@m.</span>stern<span style="display: none;">.nosp@m.</span>.edu</a></p>
<p>Spencer Williams &ndash; <a href="#" onclick="location.href='mai'+'lto:'+'pro'+'je'+'ct-'+'ma'+'nag'+'er'+'@nu'+'so'+'lar'+'.o'+'rg'; return false;">proje<span style="display: none;">.nosp@m.</span>ct-m<span style="display: none;">.nosp@m.</span>anage<span style="display: none;">.nosp@m.</span>r@nu<span style="display: none;">.nosp@m.</span>solar<span style="display: none;">.nosp@m.</span>.org</a></p>
<h2>Licence </h2>
<p>This library is Copyright 2015 by NUsolar. The code may be used in non-commercial projects without compensation, but we would appreciate it if you let us know that you're using it.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000005">Todo:</a></b></dt><dd><h2>Documentation To-Dos </h2>
<ul>
<li>Write description of how to add a new CAN frame</li>
<li>Example snippets for each major function.</li>
<li><a class="el" href="struct_c_a_n_filter_opt.html">CANFilterOpt</a> class description</li>
<li>Detailed descriptions for each <a class="el" href="class_c_a_n___i_o.html" title="Class for handling CAN I/O operations using the MCP2515 CAN controller. ">CAN_IO</a> callable function. </li>
</ul>
</dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
